name: Mobile iOS CI/CD

on:
  workflow_dispatch:
    inputs:
      build_mode:
        description: CI mode (unsigned build) or CD mode (signed IPA)
        required: true
        default: ci-unsigned
        type: choice
        options:
          - ci-unsigned
          - cd-signed
      create_release:
        description: Publish artifacts to GitHub Release
        required: true
        default: false
        type: boolean
      release_tag:
        description: Release tag (required when create_release is true)
        required: false
        type: string
      release_name:
        description: Release name
        required: false
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build iOS
    runs-on: macos-latest
    defaults:
      run:
        shell: bash
        working-directory: apps/native

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.9.0
          run_install: false

      - name: Install dependencies
        run: cd ../.. && pnpm install --frozen-lockfile

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install CocoaPods
        run: |
          gem install cocoapods --no-document
          cd ios && pod install --repo-update

      - name: Build (unsigned, simulator)
        if: ${{ inputs.build_mode == 'ci-unsigned' }}
        run: |
          xcodebuild \
            -workspace ios/MindPocket.xcworkspace \
            -scheme MindPocket \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Archive unsigned app bundle
        if: ${{ inputs.build_mode == 'ci-unsigned' }}
        run: |
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -path "*/Build/Products/Release-iphonesimulator/MindPocket.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "Unable to find MindPocket.app in DerivedData"
            exit 1
          fi
          mkdir -p ios/build
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" ios/build/MindPocket-unsigned-simulator.zip

      - name: Validate signing secrets
        if: ${{ inputs.build_mode == 'cd-signed' }}
        run: |
          required_vars=(
            IOS_TEAM_ID
            IOS_DIST_CERT_BASE64
            IOS_DIST_CERT_PASSWORD
            IOS_PROVISION_PROFILE_BASE64
            IOS_PROVISION_PROFILE_NAME
            IOS_KEYCHAIN_PASSWORD
          )
          for v in "${required_vars[@]}"; do
            if [ -z "${!v}" ]; then
              echo "Missing secret: $v"
              exit 1
            fi
          done
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_DIST_CERT_BASE64: ${{ secrets.IOS_DIST_CERT_BASE64 }}
          IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          IOS_PROVISION_PROFILE_NAME: ${{ secrets.IOS_PROVISION_PROFILE_NAME }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}

      - name: Configure signing
        if: ${{ inputs.build_mode == 'cd-signed' }}
        run: |
          CERT_PATH=$RUNNER_TEMP/cert.p12
          PROFILE_PATH=$RUNNER_TEMP/profile.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain-db

          printf '%s' "$IOS_DIST_CERT_BASE64" | base64 -D > "$CERT_PATH"
          printf '%s' "$IOS_PROVISION_PROFILE_BASE64" | base64 -D > "$PROFILE_PATH"

          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$IOS_DIST_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PROFILE_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/
        env:
          IOS_DIST_CERT_BASE64: ${{ secrets.IOS_DIST_CERT_BASE64 }}
          IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}

      - name: Archive signed app
        if: ${{ inputs.build_mode == 'cd-signed' }}
        run: |
          mkdir -p ios/build
          xcodebuild \
            -workspace ios/MindPocket.xcworkspace \
            -scheme MindPocket \
            -configuration Release \
            -archivePath ios/build/MindPocket.xcarchive \
            DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$IOS_PROVISION_PROFILE_NAME" \
            archive
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_PROVISION_PROFILE_NAME: ${{ secrets.IOS_PROVISION_PROFILE_NAME }}

      - name: Export IPA
        if: ${{ inputs.build_mode == 'cd-signed' }}
        run: |
          cat > ios/build/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${IOS_TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.turbo.example</key>
              <string>${IOS_PROVISION_PROFILE_NAME}</string>
            </dict>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath ios/build/MindPocket.xcarchive \
            -exportPath ios/build \
            -exportOptionsPlist ios/build/ExportOptions.plist

      - name: Upload unsigned iOS artifact
        if: ${{ inputs.build_mode == 'ci-unsigned' }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-simulator-app
          path: apps/native/ios/build/MindPocket-unsigned-simulator.zip
          if-no-files-found: error

      - name: Upload signed IPA artifact
        if: ${{ inputs.build_mode == 'cd-signed' }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: apps/native/ios/build/*.ipa
          if-no-files-found: error

      - name: Validate release inputs
        if: ${{ inputs.create_release }}
        run: |
          if [ -z "${{ inputs.release_tag }}" ]; then
            echo "release_tag is required when create_release is true"
            exit 1
          fi

      - name: Publish unsigned build to GitHub Release
        if: ${{ inputs.create_release && inputs.build_mode == 'ci-unsigned' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name != '' && inputs.release_name || inputs.release_tag }}
          append_body: true
          generate_release_notes: true
          files: apps/native/ios/build/MindPocket-unsigned-simulator.zip

      - name: Publish IPA to GitHub Release
        if: ${{ inputs.create_release && inputs.build_mode == 'cd-signed' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          name: ${{ inputs.release_name != '' && inputs.release_name || inputs.release_tag }}
          append_body: true
          files: apps/native/ios/build/*.ipa
